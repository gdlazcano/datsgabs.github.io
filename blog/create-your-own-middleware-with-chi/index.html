<!doctype html><html lang=en prefix="og: http://ogp.me/ns#"><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Gabriel Lazcano"><title>Create your own middleware with Chi</title><meta name=twitter:card content="summary"><meta name=twitter:site content="@datsgabs"><meta name=twitter:creator content="@datsgabs"><meta name=twitter:image content="https://gabriellazcano.com/images/habbo-card.png"><meta property="og:title" content="Create your own middleware with Chi"><meta property="og:description" content="In this post I'm going to explain how to create your own middleware in Chi, how to get the values from route handlers and other middlewares. And give some context of how the Chi library is used"><meta property="og:type" content="article"><meta property="og:image" content="https://gabriellazcano.com/images/habbo-card.png"><meta name=description content="In this post I'm going to explain how to create your own middleware in Chi, how to get the values from route handlers and other middlewares. And give some context of how the Chi library is used"><meta property="og:locale" content="en_US"><meta property="og:url" content="https://gabriellazcano.com"><meta property="og:sitename" content="Gabriel Lazcano"><meta name=twitter:dnt content="on"><link rel="shortcut icon" href=/images/habbo-card.png type=image/png><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Fira+Code&family=Inter&display=swap" rel=stylesheet><script data-goatcounter=https://gabriellazcano.goatcounter.com/count async src=//gc.zgo.at/count.js></script>
<link rel=stylesheet href=https://gabriellazcano.com/scss/commons/index.min.ac0f008ff08cfe0c1ef5cbfc85e49f73133bc7bef0e4ec4b06751a5a2ba221e4.css><link rel=stylesheet href=https://gabriellazcano.com/scss/single/index.min.2562b099c8bbca9c2dcc38e6016aad681195a824de47f9579ba64d3ad2e077a8.css></head><body><div class=container><header class=navigation><a class=navigation_home-button href=/ title="Press to go Home"><img width=80 height=80 src=/images/habbo.png alt="Gabriel Lazcano"></a><h1 class="navigation_header navigation_mobile--hiden">Gabriel Lazcano</h1><p class=navigation_mobile--hiden>Fullstack web developer, living in Mexico</p><div class="social-media navigation_mobile--hiden"><a href=https://github.com/datsgabs><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub icon</title><path d="M12 .297c-6.63.0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577.0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93.0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176.0.0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22.0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22.0 1.606-.015 2.896-.015 3.286.0.315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><a href=https://twitter.com/DatsGabs><svg role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>Twitter icon</title><path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958.0 002.163-2.723c-.951.555-2.005.959-3.127 1.184A4.92 4.92.0 0011.78 8.288C7.69 8.095 4.067 6.13 1.64 3.162A4.822 4.822.0 00.974 5.637c0 1.71.87 3.213 2.188 4.096A4.904 4.904.0 01.934 9.117v.06a4.923 4.923.0 003.946 4.827 4.996 4.996.0 01-2.212.085 4.936 4.936.0 004.604 3.417A9.867 9.867.0 011.17 19.611c-.39.0-.779-.023-1.17-.067a13.995 13.995.0 007.557 2.209c9.053.0 13.998-7.496 13.998-13.985.0-.21.0-.42-.015-.63A9.935 9.935.0 0024 4.59z"/></svg></a><a href=/index.xml><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>RSS icon</title><path d="M19.199 24C19.199 13.467 10.533 4.8.0 4.8V0c13.165.0 24 10.835 24 24h-4.801zM3.291 17.415c1.814.0 3.293 1.479 3.293 3.295.0 1.813-1.485 3.29-3.301 3.29C1.47 24 0 22.526.0 20.71s1.475-3.294 3.291-3.295zM15.909 24h-4.665c0-6.169-5.075-11.245-11.244-11.245V8.09c8.727.0 15.909 7.184 15.909 15.91z"/></svg></a></div><nav class=navigation_menu id=links><ul><li><a href=https://gabriellazcano.com/>English</a></li><li><a href=https://gabriellazcano.com/es/>Spanish</a></li></ul><br><hr><br><a href=/archive title>Archive</a>
<a href=/tags title>Tags</a>
<a href=/newsletter title>Newsletter</a><br><hr><br><small>© 2021 Gabriel Lazcano</small></nav><div class=navigation_hamburger id=hamburger><div class="hamburger_line half start"></div><div class=hamburger_line></div><div class="hamburger_line half end"></div></div><script src=/js/hamburger-menu.min.012633aa6ae3d71a9458231a641bb7e429945510ec8056c27028757c77c8c83c.js defer></script></header><main class=main><div class=single-header><h1 class=single-header_title>Create your own middleware with Chi</h1><p class=title-footnote>Published on: <b>July 15, 2021</b></p><p class=title-footnote>Reading time: <b>2 min</b></p></div><article id=article class=article><h2 id=introduction>Introduction</h2><p><a href=https://github.com/go-chi/chi>chi</a> is a lightweight, idiomatic and composable router for building Go HTTP services.</p><p>I&rsquo;ve had some trouble recently in finding out how the chi library works. It is definitely powerful and in my opinion one of the best alternatives out there. You can check out the features and the performance if you want to make an informed opinion for choosing it.</p><p>In the GitHub they briefly show an example of how they are using it but they don&rsquo;t dive much into it. It&rsquo;s pretty straightforward actually.</p><p>You call a middleware using <code>r.Use</code> where r is the router. Either a nested router like in this example.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>r</span><span class=p>.</span><span class=nf>Route</span><span class=p>(</span><span class=s>&#34;/user&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>r</span> <span class=nx>chi</span><span class=p>.</span><span class=nx>Router</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>r</span><span class=p>.</span><span class=nf>Use</span><span class=p>(</span><span class=nx>user</span><span class=p>.</span><span class=nx>UserContextBody</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>r</span><span class=p>.</span><span class=nf>Route</span><span class=p>(</span><span class=s>&#34;/{username}&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>r</span> <span class=nx>chi</span><span class=p>.</span><span class=nx>Router</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// your code
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span></code></pre></div><p>Or the main router</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>r</span> <span class=o>:=</span> <span class=nx>chi</span><span class=p>.</span><span class=nf>NewRouter</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// middleware stack
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>r</span><span class=p>.</span><span class=nf>Use</span><span class=p>(</span><span class=nx>middleware</span><span class=p>.</span><span class=nx>RequestID</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>r</span><span class=p>.</span><span class=nf>Use</span><span class=p>(</span><span class=nx>middleware</span><span class=p>.</span><span class=nx>RealIP</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>r</span><span class=p>.</span><span class=nf>Use</span><span class=p>(</span><span class=nx>middleware</span><span class=p>.</span><span class=nx>Logger</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>r</span><span class=p>.</span><span class=nf>Use</span><span class=p>(</span><span class=nx>middleware</span><span class=p>.</span><span class=nx>Recoverer</span><span class=p>)</span>
</span></span></code></pre></div><h2 id=what-is-a-middleware-in-chi>What is a middleware in Chi?</h2><p>A middleware is a function that receives a http.Handler and returns a http.Handler. Yeah it&rsquo;s not quite self-explanatory.</p><p>Anything you can do with the standard library you can do. We just have to serve the http.Handler from the parameter, you can find it as <code>next</code> in the Chi library.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>UserContextBody</span><span class=p>(</span><span class=nx>next</span> <span class=nx>http</span><span class=p>.</span><span class=nx>Handler</span><span class=p>)</span> <span class=nx>http</span><span class=p>.</span><span class=nx>Handler</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>http</span><span class=p>.</span><span class=nf>HandlerFunc</span><span class=p>(</span><span class=kd>func</span><span class=p>(</span><span class=nx>rw</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>user</span> <span class=nx>User</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>err</span> <span class=o>:=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>NewDecoder</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>Body</span><span class=p>).</span><span class=nf>Decode</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>ctx</span> <span class=o>:=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>WithValue</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nf>Context</span><span class=p>(),</span> <span class=s>&#34;user&#34;</span><span class=p>,</span> <span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>next</span><span class=p>.</span><span class=nf>ServeHTTP</span><span class=p>(</span><span class=nx>rw</span><span class=p>,</span> <span class=nx>r</span><span class=p>.</span><span class=nf>WithContext</span><span class=p>(</span><span class=nx>ctx</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>In the example above I&rsquo;m getting the body of the request, decoding it into a struct and adding it to the next handler, this is how we can chain multiple middlewares.</p><p>And as you may have noticed we are using context this is to pass values throughout the handlers. We have to pass the context (for passing it from previous middlewares), a key and the value. You can check the <a href="https://pkg.go.dev/context?utm_source=gopls#WithValue">documentation for context</a></p><h2 id=get-the-context>Get the context</h2><p>In order to get the context either from another middleware or from a route handler, we have to call the context function from the http.Request and get the key we used while defining the context, then we have to pass type of the context we are passed. In this case we were passing a <code>User</code> struct but it could be a string, and int or whatever type it&rsquo;s being passed in the context.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// example for getting a string from context
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>ctx</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>Context</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nx>key</span> <span class=o>:=</span> <span class=nx>ctx</span><span class=p>.</span><span class=nf>Value</span><span class=p>(</span><span class=s>&#34;key&#34;</span><span class=p>).(</span><span class=kt>string</span><span class=p>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>r</span><span class=p>.</span><span class=nf>Use</span><span class=p>(</span><span class=nx>UserContextBody</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>r</span><span class=p>.</span><span class=nf>Route</span><span class=p>(</span><span class=s>&#34;/{username}&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>r</span> <span class=nx>chi</span><span class=p>.</span><span class=nx>Router</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>r</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;/&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>rw</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=err>\</span><span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// your code
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>r</span><span class=p>.</span><span class=nf>Post</span><span class=p>(</span><span class=s>&#34;/&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>rw</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=err>\</span><span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>u</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>Context</span><span class=p>().</span><span class=nf>Value</span><span class=p>(</span><span class=s>&#34;user&#34;</span><span class=p>).(</span><span class=nx>User</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=c1>// your code
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>})</span>
</span></span></code></pre></div><a class=editPage href=https://github.com/DatsGabs/datsgabs.github.io/blob/main/content/blog/Create%20your%20own%20middleware%20with%20Chi.md><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 .297c-6.63.0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577.0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93.0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176.0.0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22.0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22.0 1.606-.015 2.896-.015 3.286.0.315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>Edit this page on Github</a></article><div class=article-bottom><h2>Share this article</h2><div class=share-buttons><a href="https://twitter.com/intent/tweet?text=Create%20your%20own%20middleware%20with%20Chi&url=https%3a%2f%2fgabriellazcano.com%2fblog%2fcreate-your-own-middleware-with-chi%2f&via=datsgabs" target=_blank rel="noopener noreferrer" class="share-twitter-btn article-bottom_btn"><svg role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958.0 002.163-2.723c-.951.555-2.005.959-3.127 1.184A4.92 4.92.0 0011.78 8.288C7.69 8.095 4.067 6.13 1.64 3.162A4.822 4.822.0 00.974 5.637c0 1.71.87 3.213 2.188 4.096A4.904 4.904.0 01.934 9.117v.06a4.923 4.923.0 003.946 4.827 4.996 4.996.0 01-2.212.085 4.936 4.936.0 004.604 3.417A9.867 9.867.0 011.17 19.611c-.39.0-.779-.023-1.17-.067a13.995 13.995.0 007.557 2.209c9.053.0 13.998-7.496 13.998-13.985.0-.21.0-.42-.015-.63A9.935 9.935.0 0024 4.59z"/></svg><span>Tweet</span></a>
<a href="https://www.reddit.com/submit?title=Create%20your%20own%20middleware%20with%20Chi&url=https%3a%2f%2fgabriellazcano.com%2fblog%2fcreate-your-own-middleware-with-chi%2f" class="share-reddit_btn article-bottom_btn" target=_blank><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 0A12 12 0 000 12a12 12 0 0012 12 12 12 0 0012-12A12 12 0 0012 0zm5.01 4.744c.688.0 1.25.561 1.25 1.249a1.25 1.25.0 01-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968.0 1.754.786 1.754 1.754.0.716-.435 1.333-1.01 1.614a3.111 3.111.0 01.042.52c0 2.694-3.13 4.87-7.004 4.87s-7.004-2.176-7.004-4.87c0-.183.015-.366.043-.534A1.748 1.748.0 014.028 12c0-.968.786-1.754 1.754-1.754.463.0.898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342.0 01.14-.197.35.35.0 01.238-.042l2.906.617a1.214 1.214.0 011.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687.0 1.248-.561 1.248-1.249S9.937 12 9.249 12zm5.5.0c-.687.0-1.248.561-1.248 1.25.0.687.561 1.248 1.249 1.248S16 13.937 16 13.249c0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327.0 00-.231.094.33.33.0 000 .463c.842.842 2.484.913 2.961.913s2.105-.056 2.961-.913a.361.361.0 00.029-.463.33.33.0 00-.464.0c-.547.533-1.684.73-2.512.73-.828.0-1.979-.196-2.512-.73a.326.326.0 00-.232-.095z"/></svg>Reddit</a></div></div><div class=comments><h2>Comments</h2><script src=https://utteranc.es/client.js repo=DatsGabs/datsgabs.github.io issue-term=og:title theme=github-dark crossorigin=anonymous async loading=lazy></script><p id=commentsNotice>utteranc.es uses Github Issues, no data is stored.<br>You can disable
it from your
<a href=https://github.com/settings/apps/authorizations>authorized apps.</a></p></div><div class=single_pagination><div class=pagination_title><span class=pagination_title-h>Read other articles</span></div><div class=pagination_buttons><span class="button previous"><a href=https://gabriellazcano.com/blog/easiest-page-transitions-in-react-with-framer-motion/><span class=button_icon>←</span>
<span class=button_text>Easiest page transitions in React with Framer Motion</span></a></span>
<span class="button next"><a href=https://gabriellazcano.com/blog/create-a-custom-cursor-that-follows-you-and-inverts-colors/><span class=button_text>Create a custom cursor that follows you and inverts colors</span>
<span class=button_icon>→</span></a></span></div></div><script src=/js/index.min.3f13e00fc731fd77a64b7ed3285f1a98b33c270799eebae712fa1d635bab8e88.js defer></script></main><aside><div class=toc><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#what-is-a-middleware-in-chi>What is a middleware in Chi?</a></li><li><a href=#get-the-context>Get the context</a></li></ul></nav></div><script src=/js/toc.min.6a8fabc5c1109b2517b3c86dfd66968d6ab8b6e87343997a6309250fc8fb9f62.js></script></aside></div></body></html>