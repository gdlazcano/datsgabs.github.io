<!doctype html><html lang=en prefix="og: http://ogp.me/ns#"><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Gabriel Lazcano"><title>Don't make your SQL requests like this! Dont get hacked: SQL Injection</title><meta name=twitter:card content="summary"><meta name=twitter:site content="@datsgabs"><meta name=twitter:creator content="@datsgabs"><meta name=twitter:image content="https://gabriellazcano.com/images/habbo-card.png"><meta property="og:title" content="Don't make your SQL requests like this! Dont get hacked: SQL Injection"><meta property="og:description" content="In this post I'm going to explain how to prevent an SQL Injection and show an example of a vulnerable app in expressjs"><meta property="og:type" content="article"><meta property="og:image" content="https://gabriellazcano.com/images/habbo-card.png"><meta property="og:locale" content="en_US"><meta property="og:url" content="https://gabriellazcano.com"><meta property="og:sitename" content="Gabriel Lazcano"><meta name=twitter:dnt content="on"><link rel="shortcut icon" href=/images/habbo-card.png type=image/png><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Fira+Code&family=Inter&display=swap" rel=stylesheet><link rel=stylesheet href=https://gabriellazcano.com/scss/commons/index.min.b652fd7871dc3fa96e01167da038a837ddeae190dba57622f7c5e08bffdeb05f.css><link rel=stylesheet href=https://gabriellazcano.com/scss/single/index.min.f9f9803305018a6b5ce4e6f6c525d512fb3b8054ea3a520290b0b0af4cf3fecc.css></head><body><div class=container><nav class=navigation><a class=navigation_home-button href=/ title="Press to go Home"><img width=80 height=80 src=/images/habbo.png alt="Gabriel Lazcano"></a><h1 class="navigation_header navigation_mobile--hiden">Gabriel Lazcano</h1><p class=navigation_mobile--hiden>Fullstack web developer, living in Mexico</p><div class="social-media navigation_mobile--hiden"><a href=https://github.com/datsgabs><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub icon</title><path d="M12 .297c-6.63.0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577.0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93.0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176.0.0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22.0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22.0 1.606-.015 2.896-.015 3.286.0.315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><a href=https://twitter.com/datsgabs><svg role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>Twitter icon</title><path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958.0 002.163-2.723c-.951.555-2.005.959-3.127 1.184A4.92 4.92.0 0011.78 8.288C7.69 8.095 4.067 6.13 1.64 3.162A4.822 4.822.0 00.974 5.637c0 1.71.87 3.213 2.188 4.096A4.904 4.904.0 01.934 9.117v.06a4.923 4.923.0 003.946 4.827 4.996 4.996.0 01-2.212.085 4.936 4.936.0 004.604 3.417A9.867 9.867.0 011.17 19.611c-.39.0-.779-.023-1.17-.067a13.995 13.995.0 007.557 2.209c9.053.0 13.998-7.496 13.998-13.985.0-.21.0-.42-.015-.63A9.935 9.935.0 0024 4.59z"/></svg></a><a href=/index.xml><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>RSS icon</title><path d="M19.199 24C19.199 13.467 10.533 4.8.0 4.8V0c13.165.0 24 10.835 24 24h-4.801zM3.291 17.415c1.814.0 3.293 1.479 3.293 3.295.0 1.813-1.485 3.29-3.301 3.29C1.47 24 0 22.526.0 20.71s1.475-3.294 3.291-3.295zM15.909 24h-4.665c0-6.169-5.075-11.245-11.244-11.245V8.09c8.727.0 15.909 7.184 15.909 15.91z"/></svg></a></div><div class=navigation_menu id=links><a href=/tags title>Tags</a>
<a href=/archive title>Archive</a>
<a href=/newsletter title>Newsletter</a><br><hr><br><small>Â© 2021 Gabriel Lazcano</small></div><div class=navigation_hamburger id=hamburger><div class="hamburger_line half start"></div><div class=hamburger_line></div><div class="hamburger_line half end"></div></div><script src=/js/hamburger-menu.min.012633aa6ae3d71a9458231a641bb7e429945510ec8056c27028757c77c8c83c.js defer></script></nav><main class=main><div class=single-header><h1 class=single-header_title>Don't make your SQL requests like this! Dont get hacked: SQL Injection</h1><p class=title-footnote>Published on <b>Mar 31, 2021</b></p><p class=title-footnote>Reading time: <b>4 min</b></p></div><article id=article class=article><h2 id=introduction>Introduction</h2><p>So I&rsquo;ve been learning SQL and something came to my mind. How safe is this, I won&rsquo;t lie I&rsquo;ve heard of SQL injections before but never really got into it. But now I know it&rsquo;s really a dangerous tool if you are not doing things correctly, and the best way of preventing this is knowing how to do it. Also for what I&rsquo;ve investigated it seems that a lot of sites are vulnerable to this kind of attacks so we have to make awareness of the topic.</p><h2 id=example-server>Example server</h2><p>In this occasion I&rsquo;m going to be using express and mysql to demonstrate the attack and how to fix it. It&rsquo;s important however that you investigate your specific stack so you can be more secure. Firstly I&rsquo;m going to create a new <code>express</code> server with the <code>express-session</code> middleware to manage authentication and <code>body-parser</code> to get the body from the <code>post</code> request from the form.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>express</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;express&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>session</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;express-session&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>bodyParser</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;body-parser&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>path</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;path&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>app</span> <span class=o>=</span> <span class=nx>express</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>session</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=nx>secret</span><span class=o>:</span> <span class=s1>&#39;secret&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>resave</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>saveUninitialized</span><span class=o>:</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=p>}));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>bodyParser</span><span class=p>.</span><span class=nx>urlencoded</span><span class=p>({</span><span class=nx>extended</span> <span class=o>:</span> <span class=kc>true</span><span class=p>}));</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>bodyParser</span><span class=p>.</span><span class=nx>json</span><span class=p>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>,</span> <span class=kd>function</span><span class=p>(</span><span class=nx>request</span><span class=p>,</span> <span class=nx>response</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>response</span><span class=p>.</span><span class=nx>sendFile</span><span class=p>(</span><span class=nx>path</span><span class=p>.</span><span class=nx>join</span><span class=p>(</span><span class=err>\</span><span class=nx>_</span><span class=err>\</span><span class=nx>_dirname</span> <span class=o>+</span> <span class=s1>&#39;/login.html&#39;</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/home&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>request</span><span class=p>,</span> <span class=nx>response</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>request</span><span class=p>.</span><span class=nx>session</span><span class=p>.</span><span class=nx>loggedin</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>response</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=s1>&#39;Welcome back, &#39;</span> <span class=o>+</span> <span class=nx>request</span><span class=p>.</span><span class=nx>session</span><span class=p>.</span><span class=nx>username</span> <span class=o>+</span> <span class=s1>&#39;!&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>response</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=s1>&#39;Please login to view this page!&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>response</span><span class=p>.</span><span class=nx>end</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>listen</span><span class=p>(</span><span class=mi>8000</span><span class=p>);</span></span></span></code></pre></div><p>Now I have to craete a simple <code>login.html</code> file to be served</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=c>&lt;!-- login.html --&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>&lt;!DOCTYPE html&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>html</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>	<span class=p>&lt;</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>		<span class=p>&lt;</span><span class=nt>meta</span> <span class=na>charset</span><span class=o>=</span><span class=s>&#34;utf-8&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>		<span class=p>&lt;</span><span class=nt>title</span><span class=p>&gt;</span>Login Form Tutorial<span class=p>&lt;/</span><span class=nt>title</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>		<span class=p>&lt;</span><span class=nt>style</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>		<span class=p>.</span><span class=nc>login-form</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>width</span><span class=p>:</span> <span class=mi>300</span><span class=kt>px</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=k>margin</span><span class=p>:</span> <span class=mi>0</span> <span class=kc>auto</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>.</span><span class=nc>login-form</span> <span class=nt>h1</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>text-align</span><span class=p>:</span> <span class=kc>center</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=k>color</span><span class=p>:</span> <span class=mh>#4d4d4d</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=k>font-size</span><span class=p>:</span> <span class=mi>24</span><span class=kt>px</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=k>padding</span><span class=p>:</span> <span class=mi>20</span><span class=kt>px</span> <span class=mi>0</span> <span class=mi>20</span><span class=kt>px</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>.</span><span class=nc>login-form</span> <span class=nt>input</span><span class=o>[</span><span class=nt>type</span><span class=o>=</span><span class=s2>&#34;password&#34;</span><span class=o>],</span>
</span></span><span class=line><span class=cl>		<span class=p>.</span><span class=nc>login-form</span> <span class=nt>input</span><span class=o>[</span><span class=nt>type</span><span class=o>=</span><span class=s2>&#34;text&#34;</span><span class=o>]</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>width</span><span class=p>:</span> <span class=mi>100</span><span class=kt>%</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=k>padding</span><span class=p>:</span> <span class=mi>15</span><span class=kt>px</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=k>border</span><span class=p>:</span> <span class=mi>1</span><span class=kt>px</span> <span class=kc>solid</span> <span class=mh>#dddddd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=k>margin-bottom</span><span class=p>:</span> <span class=mi>15</span><span class=kt>px</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=k>box-sizing</span><span class=p>:</span><span class=kc>border-box</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>.</span><span class=nc>login-form</span> <span class=nt>input</span><span class=o>[</span><span class=nt>type</span><span class=o>=</span><span class=s2>&#34;submit&#34;</span><span class=o>]</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>width</span><span class=p>:</span> <span class=mi>100</span><span class=kt>%</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=k>padding</span><span class=p>:</span> <span class=mi>15</span><span class=kt>px</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=k>background-color</span><span class=p>:</span> <span class=mh>#535b63</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=k>border</span><span class=p>:</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=k>box-sizing</span><span class=p>:</span> <span class=kc>border-box</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=k>cursor</span><span class=p>:</span> <span class=kc>pointer</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=k>font-weight</span><span class=p>:</span> <span class=kc>bold</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=k>color</span><span class=p>:</span> <span class=mh>#ffffff</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>&lt;/</span><span class=nt>style</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>	<span class=p>&lt;/</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>	<span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>		<span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;login-form&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>			<span class=p>&lt;</span><span class=nt>h1</span><span class=p>&gt;</span>Login Form<span class=p>&lt;/</span><span class=nt>h1</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>			<span class=p>&lt;</span><span class=nt>form</span> <span class=na>action</span><span class=o>=</span><span class=s>&#34;auth&#34;</span> <span class=na>method</span><span class=o>=</span><span class=s>&#34;POST&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>				<span class=p>&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;text&#34;</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;username&#34;</span> <span class=na>placeholder</span><span class=o>=</span><span class=s>&#34;Username&#34;</span> <span class=na>required</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>				<span class=p>&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;password&#34;</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;password&#34;</span> <span class=na>placeholder</span><span class=o>=</span><span class=s>&#34;Password&#34;</span> <span class=na>required</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>				<span class=p>&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;submit&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>			<span class=p>&lt;/</span><span class=nt>form</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>		<span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>	<span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span></span></span></code></pre></div><p>And finally I have to add the <code>auth</code> url logic. This would be a post action just as specified in the HTML. I will also be importing <code>dotenv</code> to not expose my user and password in the codebase but just for testing you can leave it like this, so you have to create a <code>.env</code> file.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># .env</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>USERNAME</span> <span class=o>=</span> <span class=o>(</span>your MySQL username<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=nv>PASS</span> <span class=o>=</span> <span class=o>(</span>your MySQL password<span class=o>)</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>require</span><span class=p>(</span><span class=s1>&#39;dotenv&#39;</span><span class=p>).</span><span class=nx>config</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>mysql</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;mysql&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>connection</span> <span class=o>=</span> <span class=nx>mysql</span><span class=p>.</span><span class=nx>createConnection</span><span class=p>({</span>
</span></span><span class=line><span class=cl>	<span class=nx>host</span>     <span class=o>:</span> <span class=s1>&#39;localhost&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>user</span>     <span class=o>:</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>USERNAME</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>password</span> <span class=o>:</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>PASS</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>database</span> <span class=o>:</span> <span class=s1>&#39;test&#39;</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>post</span><span class=p>(</span><span class=s1>&#39;/auth&#39;</span><span class=p>,</span> <span class=kd>function</span><span class=p>(</span><span class=nx>request</span><span class=p>,</span> <span class=nx>response</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>username</span> <span class=o>=</span> <span class=nx>request</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>username</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>password</span> <span class=o>=</span> <span class=nx>request</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>password</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=nx>username</span> <span class=o>&amp;&amp;</span> <span class=nx>password</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// vulnerable
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>connection</span><span class=p>.</span><span class=nx>query</span><span class=p>(</span><span class=sb>`SELECT * FROM users WHERE username=&#39;</span><span class=si>${</span><span class=nx>username</span><span class=si>}</span><span class=sb>&#39; AND password=&#39;</span><span class=si>${</span><span class=nx>password</span><span class=si>}</span><span class=sb>&#39;`</span><span class=p>,</span> <span class=kd>function</span><span class=p>(</span><span class=nx>error</span><span class=p>,</span> <span class=nx>results</span><span class=p>,</span> <span class=nx>fields</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=nx>results</span><span class=p>.</span><span class=nx>length</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>request</span><span class=p>.</span><span class=nx>session</span><span class=p>.</span><span class=nx>loggedin</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=nx>request</span><span class=p>.</span><span class=nx>session</span><span class=p>.</span><span class=nx>username</span> <span class=o>=</span> <span class=nx>results</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>username</span><span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=nx>response</span><span class=p>.</span><span class=nx>redirect</span><span class=p>(</span><span class=s1>&#39;/home&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>response</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=s1>&#39;Incorrect Username and/or Password!&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>			
</span></span><span class=line><span class=cl>			<span class=nx>response</span><span class=p>.</span><span class=nx>end</span><span class=p>();</span>
</span></span><span class=line><span class=cl>		<span class=p>});</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>response</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=s1>&#39;Please enter Username and Password!&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=nx>response</span><span class=p>.</span><span class=nx>end</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div><h3 id=vulnerabily-explanation>Vulnerabily explanation</h3><p>And here is the vulnerable part of the whole application. In the <code>connection.query()</code>. Basically here we are getting the body of the request with the username and password and making a string that function as a MySQL query BUT what if the username or passsword are not normal strings.</p><p>What would happen if we requested something like this <code>' OR 1=1 --</code> as user and " " as password</p><p>I&rsquo;ll tell you what would happen. We would be doing this SQL request.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>users</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>username</span><span class=o>=</span><span class=s1>&#39;&#39;</span><span class=w> </span><span class=k>or</span><span class=w> </span><span class=mi>1</span><span class=o>=</span><span class=mi>1</span><span class=w> </span><span class=c1>-- AND password=&#34; &#34;</span></span></span></code></pre></div><p>As you can see in the linter the 2 dashes are commenting the <code>AND</code> part. So we reduce the query to &ldquo;is username empty or 1 equal 1&rdquo; and MySQL would say &ldquo;there is no user with an empty space but 1 equals 1&rdquo; so it will return every single user in the database. Then we would be authenticating as the first user which is normally&mldr; yes you guessed, it the admin.</p><video controls>
<source src=/videos/1.mp4 type=video/mp4>Your browser does not support the video tag.</video><h2 id=fixing-the-query>Fixing the query</h2><p>So with express it&rsquo;s pretty simple to solve this. We need tweak our code so any user input is automatically spaced before being executed and in the MySQL library for nodejs you can use placeholders.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>post</span><span class=p>(</span><span class=s1>&#39;/auth&#39;</span><span class=p>,</span> <span class=kd>function</span><span class=p>(</span><span class=nx>request</span><span class=p>,</span> <span class=nx>response</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>username</span> <span class=o>=</span> <span class=nx>request</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>username</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>password</span> <span class=o>=</span> <span class=nx>request</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>password</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=nx>username</span> <span class=o>&amp;&amp;</span> <span class=nx>password</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// not vulnerable
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>connection</span><span class=p>.</span><span class=nx>query</span><span class=p>(</span><span class=s1>&#39;SELECT * FROM users WHERE username= ? AND password= ?&#39;</span><span class=p>,</span> <span class=p>[</span><span class=nx>username</span><span class=p>,</span> <span class=nx>password</span><span class=p>],</span><span class=kd>function</span><span class=p>(</span><span class=nx>error</span><span class=p>,</span> <span class=nx>results</span><span class=p>,</span> <span class=nx>fields</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=nx>results</span><span class=p>.</span><span class=nx>length</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>request</span><span class=p>.</span><span class=nx>session</span><span class=p>.</span><span class=nx>loggedin</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=nx>request</span><span class=p>.</span><span class=nx>session</span><span class=p>.</span><span class=nx>username</span> <span class=o>=</span> <span class=nx>results</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>username</span><span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=nx>response</span><span class=p>.</span><span class=nx>redirect</span><span class=p>(</span><span class=s1>&#39;/home&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>response</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=s1>&#39;Incorrect Username and/or Password!&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>			
</span></span><span class=line><span class=cl>			<span class=nx>response</span><span class=p>.</span><span class=nx>end</span><span class=p>();</span>
</span></span><span class=line><span class=cl>		<span class=p>});</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>response</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=s1>&#39;Please enter Username and Password!&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=nx>response</span><span class=p>.</span><span class=nx>end</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div><p>After this you might want to check if you are using concatenation to make your SQL requests in order to not be vulnerable to this kind of attacks :))</p><a class=editPage href=https://github.com/DatsGabs/datsgabs.github.io/blob/main/content/blog/dont-make-your-sql-requests-like-this-dont-get-hacked.md><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 .297c-6.63.0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577.0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93.0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176.0.0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22.0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22.0 1.606-.015 2.896-.015 3.286.0.315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>Edit this page on Github</a></article><div class=article-bottom><h2>Share this Article</h2><div class=share-buttons><a href="https://twitter.com/intent/tweet?text=Don%27t%20make%20your%20SQL%20requests%20like%20this%21%20Dont%20get%20hacked%3a%20SQL%20Injection&url=https%3a%2f%2fgabriellazcano.com%2fblog%2fdont-make-your-sql-requests-like-this-dont-get-hacked%2f&via=datsgabs" target=_blank rel="noopener noreferrer" class="share-twitter-btn article-bottom_btn"><svg role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958.0 002.163-2.723c-.951.555-2.005.959-3.127 1.184A4.92 4.92.0 0011.78 8.288C7.69 8.095 4.067 6.13 1.64 3.162A4.822 4.822.0 00.974 5.637c0 1.71.87 3.213 2.188 4.096A4.904 4.904.0 01.934 9.117v.06a4.923 4.923.0 003.946 4.827 4.996 4.996.0 01-2.212.085 4.936 4.936.0 004.604 3.417A9.867 9.867.0 011.17 19.611c-.39.0-.779-.023-1.17-.067a13.995 13.995.0 007.557 2.209c9.053.0 13.998-7.496 13.998-13.985.0-.21.0-.42-.015-.63A9.935 9.935.0 0024 4.59z"/></svg><span>Tweet</span></a>
<a href="https://www.reddit.com/submit?title=Don%27t%20make%20your%20SQL%20requests%20like%20this%21%20Dont%20get%20hacked%3a%20SQL%20Injection&url=https%3a%2f%2fgabriellazcano.com%2fblog%2fdont-make-your-sql-requests-like-this-dont-get-hacked%2f" class="share-reddit_btn article-bottom_btn" target=_blank><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 0A12 12 0 000 12a12 12 0 0012 12 12 12 0 0012-12A12 12 0 0012 0zm5.01 4.744c.688.0 1.25.561 1.25 1.249a1.25 1.25.0 01-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968.0 1.754.786 1.754 1.754.0.716-.435 1.333-1.01 1.614a3.111 3.111.0 01.042.52c0 2.694-3.13 4.87-7.004 4.87s-7.004-2.176-7.004-4.87c0-.183.015-.366.043-.534A1.748 1.748.0 014.028 12c0-.968.786-1.754 1.754-1.754.463.0.898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342.0 01.14-.197.35.35.0 01.238-.042l2.906.617a1.214 1.214.0 011.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687.0 1.248-.561 1.248-1.249S9.937 12 9.249 12zm5.5.0c-.687.0-1.248.561-1.248 1.25.0.687.561 1.248 1.249 1.248S16 13.937 16 13.249c0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327.0 00-.231.094.33.33.0 000 .463c.842.842 2.484.913 2.961.913s2.105-.056 2.961-.913a.361.361.0 00.029-.463.33.33.0 00-.464.0c-.547.533-1.684.73-2.512.73-.828.0-1.979-.196-2.512-.73a.326.326.0 00-.232-.095z"/></svg>Reddit</a></div></div><div class=comments><h2>Comments</h2><script src=https://utteranc.es/client.js repo=DatsGabs/datsgabs.github.io issue-term=og:title theme=github-dark crossorigin=anonymous async loading=lazy></script><p id=commentsNotice>utteranc.es uses Github Issues, no data is stored.<br>You can disable it from your <a href=https://github.com/settings/apps/authorizations>authorized apps.</a></p></div><div class=single_pagination><div class=pagination_title><span class=pagination_title-h>Read other posts</span></div><div class=pagination_buttons><span class="button previous"><a href=https://gabriellazcano.com/blog/react-hooks-give-you-superpowers/><span class=button_icon>â</span>
<span class=button_text>Combining useState and useContext gives you superpowers in React</span></a></span>
<span class="button next"><a href=https://gabriellazcano.com/blog/braces-validator-with-javascript-stacks/><span class=button_text>Braces Validator With Javascript: Stacks</span>
<span class=button_icon>â</span></a></span></div></div><script src=/js/index.min.3f13e00fc731fd77a64b7ed3285f1a98b33c270799eebae712fa1d635bab8e88.js defer></script></main><aside><div class=toc><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#example-server>Example server</a><ul><li><a href=#vulnerabily-explanation>Vulnerabily explanation</a></li></ul></li><li><a href=#fixing-the-query>Fixing the query</a></li></ul></nav></div><script src=/js/toc.min.6a8fabc5c1109b2517b3c86dfd66968d6ab8b6e87343997a6309250fc8fb9f62.js></script></aside></div></body></html>